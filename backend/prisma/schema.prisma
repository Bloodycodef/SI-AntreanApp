datasource db {
  provider = "mysql"
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  user
  company
}

enum QueueStatus {
  waiting    // in queue, not yet called
  serving    // currently being served
  done       // completed
  skipped    // didn't respond when called
  cancelled  // left the queue
}

enum SessionStatus {
  active
  paused
  closed
}

// ─── EXISTING MODELS ──────────────────────────────────────────────────────────

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  password   String
  role       Role
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())

  company    Company?
  profile    UserProfile?
  emailVerificationToken EmailVerificationToken?
  refreshTokens          RefreshToken[]
  queueTickets           QueueTicket[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int      @unique
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Company {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  companyName String
  industry    String?
  website     String?
  address     String?

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  rooms Room[]
}

model UserProfile {
  id       Int     @id @default(autoincrement())
  userId   Int     @unique
  fullName String
  phone    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── ROOM ─────────────────────────────────────────────────────────────────────

model Room {
  id          Int      @id @default(autoincrement())
  companyId   Int
  name        String   // e.g. "Customer Service", "Clinic Queue"
  description String?
  secretKey   String   @unique  // user enters this to join the queue
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company  Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sessions QueueSession[]

  @@index([companyId])
}

// ─── QUEUE SESSION ─────────────────────────────────────────────────────────────
// Company manually opens and resets the queue via this model.
// One active session per room at a time.

model QueueSession {
  id            Int           @id @default(autoincrement())
  roomId        Int
  status        SessionStatus @default(active)
  currentNumber Int           @default(0)  // last issued number
  calledNumber  Int           @default(0)  // current number being served (company controls)
  openedAt      DateTime      @default(now())
  closedAt      DateTime?

  room    Room          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tickets QueueTicket[]

  @@index([roomId])
}

// ─── QUEUE TICKET ──────────────────────────────────────────────────────────────
// Created when a user joins a room using the secretKey and takes a number.

model QueueTicket {
  id          Int         @id @default(autoincrement())
  sessionId   Int
  userId      Int
  number      Int         // queue number e.g. 1, 2, 3...
  status      QueueStatus @default(waiting)
  createdAt   DateTime    @default(now())  // when they joined
  calledAt    DateTime?                   // when their number was called
  completedAt DateTime?                   // when done/skipped/cancelled

  session QueueSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, number])  // no duplicate numbers in same session
  @@unique([sessionId, userId])  // one ticket per user per session
  @@index([sessionId])
  @@index([userId])
}
